name: Auto Star Kidâ€™s Repositories

on:
  schedule:
    - cron: "0 7 * * *" # every day at 7AM UTC
  workflow_dispatch:

jobs:
  star:
    runs-on: ubuntu-latest

    steps:
      - name: Star all kidâ€™s repos and notify
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          KID_USERNAME: drewsephski
        run: |
          set -e
          echo "ðŸ” Fetching repositories for $KID_USERNAME..."
          
          # Fetch all public repos from the kid's account
          repos=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/users/drewsephski/repos?per_page=100" | jq -r '.[].name')

          if [ -z "$repos" ]; then
            echo "âš ï¸ No repositories found for $KID_USERNAME."
            exit 0
          fi

          for repo in $repos; do
            echo "Checking repository: $repo"
            
            # Check if already starred
            STARRED=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/user/starred/drewsephski/$repo")

            if [ "$STARRED" -eq 404 ]; then
              echo "â­ Starring $repo..."
              curl -s -X PUT \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/user/starred/drewsephski/$repo" > /dev/null

              echo "ðŸ“¢ Sending Discord notification..."
              if [ -n "$DISCORD_WEBHOOK" ]; then
                curl -s -X POST -H "Content-Type: application/json" \
                  -d "{\"content\": \"â­ Auto-starred a new repo: [$repo](https://github.com/drewsephski/$repo)\"}" \
                  "$DISCORD_WEBHOOK" > /dev/null
              fi
            else
              echo "âœ… Already starred $repo"
            fi
          done

          echo "ðŸŽ‰ All repositories processed successfully."
